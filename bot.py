# -*- coding: utf-8 -*-
"""bot

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1N_X-1aMDHdhNrYB3Nzk-Y78gP11Drz5n
"""

#!pip install python-telegram-bot python-dotenv

!pip install python-telegram-bot nest-asyncio

import os
import logging
from telegram import Update, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
    Application,
    CommandHandler,
    ConversationHandler,
    MessageHandler,
    filters,
    ContextTypes,
)
from dotenv import load_dotenv

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞
SELECT_SCALE, INPUT_PARAMS = range(2)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
SCALES_KEYBOARD = ReplyKeyboardMarkup(
    [
        ["ü©∫ SOFA", "üíâ MODS"],
    ],
    one_time_keyboard=True
)

CANCEL_KEYBOARD = ReplyKeyboardMarkup([["‚ùå –û—Ç–º–µ–Ω–∏—Ç—å"]], one_time_keyboard=True)

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —à–∫–∞–ª
SCALE_PARAMS = {
    "ü©∫ SOFA": [
        ("PaO2/FiO2 (–º–º —Ä—Ç.—Å—Ç.)", "pao2_fio2", float),
        ("–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (√ó10¬≥/–º–∫–ª)", "platelets", float),
        ("–ë–∏–ª–∏—Ä—É–±–∏–Ω (–º–≥/–¥–ª)", "bilirubin", float),
        ("–°—Ä–µ–¥–Ω–µ–µ –ê–î (–º–º —Ä—Ç.—Å—Ç.)", "map", float),
        ("–®–∫–∞–ª–∞ –ì–ª–∞–∑–≥–æ (3-15)", "glasgow", int),
        ("–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω (–º–≥/–¥–ª)", "creatinine", float),
        ("–î–∏—É—Ä–µ–∑ (–º–ª/—Å—É—Ç)", "urine_output", float)
    ],
    "üíâ MODS": [
        ("PaO2/FiO2 (–º–º —Ä—Ç.—Å—Ç.)", "pao2_fio2", float),
        ("–ë–∏–ª–∏—Ä—É–±–∏–Ω (–º–≥/–¥–ª)", "bilirubin", float),
        ("–ö—Ä–µ–∞—Ç–∏–Ω–∏–Ω (–º–≥/–¥–ª)", "creatinine", float),
        ("–¢—Ä–æ–º–±–æ—Ü–∏—Ç—ã (√ó10¬≥/–º–∫–ª)", "platelets", float),
        ("–®–∫–∞–ª–∞ –ì–ª–∞–∑–≥–æ (3-15)", "glasgow", int)
    ]
}

# –§—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–ª–æ–≤
def calculate_sofa(user_data):
    score = 0
    pao2_fio2 = user_data.get('pao2_fio2', 0)
    if pao2_fio2 >= 400: score +=0
    elif 300 <= pao2_fio2 < 400: score +=1
    elif 200 <= pao2_fio2 < 300: score +=2
    elif 100 <= pao2_fio2 < 200: score +=3
    else: score +=4

    platelets = user_data.get('platelets', 0)
    if platelets >=150: score +=0
    elif 100 <= platelets <150: score +=1
    elif 50 <= platelets <100: score +=2
    elif 20 <= platelets <50: score +=3
    else: score +=4

    bilirubin = user_data.get('bilirubin', 0)
    if bilirubin <1.2: score +=0
    elif 1.2 <= bilirubin <1.9: score +=1
    elif 2.0 <= bilirubin <5.9: score +=2
    elif 6.0 <= bilirubin <11.9: score +=3
    else: score +=4

    map_val = user_data.get('map', 0)
    gcs = user_data.get('glasgow', 15)
    score += 15 - gcs

    creatinine = user_data.get('creatinine', 0)
    urine = user_data.get('urine_output', 0)

    if creatinine <1.2: score +=0
    elif 1.2 <= creatinine <1.9: score +=1
    elif 2.0 <= creatinine <3.4: score +=2
    elif 3.5 <= creatinine <4.9: score +=3
    else: score +=4

    if urine >=500: score +=0
    elif 200 <= urine <500: score +=1
    else: score +=4

    return score

def calculate_mods(user_data):
    score = 0
    pao2_fio2 = user_data.get('pao2_fio2', 0)
    if pao2_fio2 <100: score +=3
    elif 100 <= pao2_fio2 <200: score +=2
    elif 200 <= pao2_fio2 <300: score +=1

    bilirubin = user_data.get('bilirubin', 0)
    if bilirubin >=6: score +=3
    elif 2 <= bilirubin <6: score +=1

    creatinine = user_data.get('creatinine', 0)
    if creatinine >=2: score +=2
    elif 1.2 <= creatinine <2: score +=1

    map_val = user_data.get('map', 0)
    if map_val <70: score +=2

    platelets = user_data.get('platelets', 0)
    if platelets <50: score +=2
    elif 50 <= platelets <100: score +=1

    gcs = 15 - user_data.get('glasgow', 15)
    score += gcs

    return score

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–∏–∞–ª–æ–≥–∞
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "üè• <b>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –±–æ—Ç-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç</b>\n"
        "üìä –í—ã–±–µ—Ä–∏—Ç–µ —à–∫–∞–ª—É –¥–ª—è –æ—Ü–µ–Ω–∫–∏:",
        reply_markup=SCALES_KEYBOARD,
        parse_mode="HTML"
    )
    return SELECT_SCALE

async def select_scale(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    user_choice = update.message.text

    if user_choice == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
        await cancel(update, context)
        return ConversationHandler.END

    if user_choice not in SCALE_PARAMS:
        await update.message.reply_text("‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —à–∫–∞–ª–∞")
        return ConversationHandler.END

    context.user_data.clear()
    context.user_data['scale'] = user_choice
    context.user_data['params'] = SCALE_PARAMS[user_choice]
    context.user_data['current_param'] = 0

    param_name = context.user_data['params'][0][0]
    await update.message.reply_text(
        f"üìù –ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä:\n{param_name}:",
        reply_markup=CANCEL_KEYBOARD
    )
    return INPUT_PARAMS

async def handle_parameter(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        if update.message.text == "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å":
            await cancel(update, context)
            return ConversationHandler.END

        current = context.user_data['current_param']
        params = context.user_data['params']
        param_name, key, param_type = params[current]

        value = param_type(update.message.text)

        context.user_data[key] = value

        if current + 1 < len(params):
            context.user_data['current_param'] += 1
            next_param = params[current + 1][0]
            await update.message.reply_text(f"‚û°Ô∏è –°–ª–µ–¥—É—é—â–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä:\n{next_param}", reply_markup=CANCEL_KEYBOARD)
            return INPUT_PARAMS
        else:
            return await show_results(update, context)

    except ValueError:
        error_msg = "‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞. –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ"
        await update.message.reply_text(error_msg, reply_markup=CANCEL_KEYBOARD)
        return INPUT_PARAMS

async def show_results(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    scale = context.user_data['scale']
    score = 0
    interpretation = ""

    # –†–∞—Å—á–µ—Ç –±–∞–ª–ª–æ–≤
    if scale == "ü©∫ SOFA":
        score = calculate_sofa(context.user_data)
        if score < 6:
            interpretation = "üü¢ –ù–∏–∑–∫–∏–π —Ä–∏—Å–∫ (&lt;10&#37; –ª–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏)"
        elif 6 <= score < 12:
            interpretation = "üü° –°—Ä–µ–¥–Ω–∏–π —Ä–∏—Å–∫ (15-20&#37; –ª–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏)"
        else:
            interpretation = "üî¥ –í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ (&gt;95&#37; –ª–µ—Ç–∞–ª—å–Ω–æ—Å—Ç–∏)"

    elif scale == "üíâ MODS":
        score = calculate_mods(context.user_data)
        if score <= 4:
            interpretation = "üü¢ –õ–µ–≥–∫–∞—è –¥–∏—Å—Ñ—É–Ω–∫—Ü–∏—è"
        elif 5 <= score <= 8:
            interpretation = "üü° –£–º–µ—Ä–µ–Ω–Ω–∞—è –ø–æ–ª–∏–æ—Ä–≥–∞–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å"
        else:
            interpretation = "üî¥ –¢—è–∂–µ–ª–∞—è –ø–æ–ª–∏–æ—Ä–≥–∞–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å"

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
    interpretation = (
        interpretation
        .replace("%", "&#37;")
        .replace("<", "&lt;")
        .replace(">", "&gt;")
    )

    result_message = (
        f"üìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ü–µ–Ω–∫–∏ –ø–æ —à–∫–∞–ª–µ {scale}</b>\n\n"
        f"‚≠ê –ù–∞–∫–æ–ø–ª–µ–Ω–æ –±–∞–ª–ª–æ–≤: <b>{score}</b>\n"
        f"üìã –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è: {interpretation}\n\n"
        "üîÑ –î–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
    )

    await update.message.reply_text(
        result_message,
        parse_mode="HTML",
        reply_markup=ReplyKeyboardRemove()
    )
    context.user_data.clear()
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text(
        "üö´ –¢–µ–∫—É—â–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ /start",
        reply_markup=ReplyKeyboardRemove()
    )
    context.user_data.clear()
    return ConversationHandler.END

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error("–û—à–∏–±–∫–∞: %s", context.error, exc_info=True)
    await update.message.reply_text(
        "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        reply_markup=ReplyKeyboardRemove()
    )
    context.user_data.clear()

def main():
    TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
    if not TOKEN:
        logger.error("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        return

# –°–æ–∑–¥–∞–µ–º –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
application = Application.builder().token(TOKEN).build()

# –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–≥–æ—à–∞–≥–æ–≤—ã–º –¥–∏–∞–ª–æ–≥–æ–º)
conv_handler = ConversationHandler(
    entry_points=[CommandHandler('start', start)],
    states={
        SELECT_SCALE: [MessageHandler(filters.TEXT & ~filters.COMMAND, select_scale)],
        INPUT_PARAMS: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_parameter)]
    },
    fallbacks=[CommandHandler('cancel', cancel)],
    allow_reentry=True
)

application.add_handler(conv_handler)
application.add_error_handler(error_handler)

PORT = int(os.environ.get("PORT", 8443))
RENDER_EXTERNAL_HOSTNAME = os.environ.get('RENDER_EXTERNAL_HOSTNAME')
if RENDER_EXTERNAL_HOSTNAME:
        logger.info("–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ –≤–µ–±—Ö—É–∫–∞")
        application.run_webhook(
            listen="0.0.0.0",
            port=PORT,
            url_path=TOKEN,
            webhook_url=f"https://{RENDER_EXTERNAL_HOSTNAME}/{TOKEN}"
        )
    else:
        logger.info("–ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ polling")
        application.run_polling()

if __name__ == '__main__':
    main()